(()=>{"use strict";var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var i in r)t.o(r,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:r[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const e=require("express");var r=t.n(e);const i=require("fs");var o=t.n(i),n=function(t,e,r,i){return new(r||(r=Promise))((function(o,n){function d(t){try{c(i.next(t))}catch(t){n(t)}}function s(t){try{c(i.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((i=i.apply(t,e||[])).next())}))};const d=new class{constructor(t){this.writeFile=t=>n(this,void 0,void 0,(function*(){try{yield o().promises.writeFile(this.fileName,JSON.stringify(t,null,2))}catch(t){console.log("Method writeFile: ",t)}})),this.readFile=()=>n(this,void 0,void 0,(function*(){try{return(yield o().promises.readFile(this.fileName,"utf8"))?JSON.parse(yield o().promises.readFile(this.fileName,"utf8")):[]}catch(t){if(-2===t.errno)try{return yield o().promises.writeFile(this.fileName,JSON.stringify([])),[]}catch(t){console.error("Could not create file in such directory. ",t)}else console.log("Method readFile: ",t);return[]}})),this.fileName=t,o().existsSync(`./${this.fileName}`)||o().promises.writeFile(`./${this.fileName}`,"").then((()=>console.log(`${this.fileName} created`)))}getAll(){return n(this,void 0,void 0,(function*(){return yield this.readFile()}))}getById(t){var e;return n(this,void 0,void 0,(function*(){try{const r=yield this.readFile();return null!==(e=r.find((e=>e.id===t)))&&void 0!==e?e:{error:"Product not found"}}catch(t){console.log("Method getById: ",t)}return{error:"fetch item method failed"}}))}addProduct(t){return n(this,void 0,void 0,(function*(){try{const e=yield this.readFile(),r=0===e.length?1:Math.max(...e.map((t=>t.id)))+1,i=(new Date).toLocaleString("es-AR");return e.push(Object.assign(Object.assign({},t),{id:r,timestamp:i})),yield this.writeFile(e),r}catch(t){console.log("Method save: ",t)}}))}updateProductById(t,e){return n(this,void 0,void 0,(function*(){try{const r=(yield this.readFile()).map((r=>r.id===Number(t)?Object.assign(Object.assign({},r),e):r));yield this.writeFile(r)}catch(t){console.log("Method update: ",t)}}))}deleteProductById(t){return n(this,void 0,void 0,(function*(){try{const e=yield this.readFile(),r=e.filter((e=>e.id!==t));return e.length===r.length?`There is NO product with id= ${t}`:(yield this.writeFile(r),`Product ${t} deleted`)}catch(t){console.log("Method deleteById: ",t)}}))}}("./src/db/products.txt");var s=function(t,e,r,i){return new(r||(r=Promise))((function(o,n){function d(t){try{c(i.next(t))}catch(t){n(t)}}function s(t){try{c(i.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((i=i.apply(t,e||[])).next())}))},c=function(t,e,r,i){return new(r||(r=Promise))((function(o,n){function d(t){try{c(i.next(t))}catch(t){n(t)}}function s(t){try{c(i.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((i=i.apply(t,e||[])).next())}))};class a{constructor(t){this.writeFile=t=>c(this,void 0,void 0,(function*(){try{yield o().promises.writeFile(a.fileName,JSON.stringify(t,null,2))}catch(t){console.log("Method: writeFile, ",t)}})),this.readCartFile=()=>c(this,void 0,void 0,(function*(){try{return(yield o().promises.readFile(a.fileName,"utf8"))?JSON.parse(yield o().promises.readFile(a.fileName,"utf8")):[]}catch(t){if(-2===t.errno)try{return yield o().promises.writeFile(a.fileName,JSON.stringify([])),[]}catch(t){console.error("Method: readFile: could not create file in such directory.",t)}else console.log("Method readFile: ",t);return[]}})),this.readProductsFile=()=>c(this,void 0,void 0,(function*(){try{return(yield o().promises.readFile(this.productFilePath,"utf8"))?JSON.parse(yield o().promises.readFile(this.productFilePath,"utf8")):[]}catch(t){if(-2===t.errno)try{return yield o().promises.writeFile(this.productFilePath,JSON.stringify([])),[]}catch(t){console.error("Could not create file in such directory. ",t)}else console.log("Method readFile: ",t);return[]}})),this.createNewCart=()=>c(this,void 0,void 0,(function*(){try{const t=yield this.readCartFile(),e=(new Date).toLocaleString("es-AR");if(0===t.length||void 0===t)return yield this.writeFile([{cartId:1,timestamp:e,products:[]}]),1;{const r=Math.max(...t.map((t=>t.cartId)))+1;return yield this.writeFile([...t,{cartId:r,timestamp:e,products:[]}]),r}}catch(t){return console.error(t),t}})),this.cartDeleteById=t=>c(this,void 0,void 0,(function*(){try{const e=yield this.readCartFile();if(0===e.length||void 0===e)return-1;{const r=e.filter((e=>e.cartId!==t));return r.length===e.length?-2:(yield this.writeFile(r),200)}}catch(t){return console.error(t),t}})),this.getProductsByCartId=t=>c(this,void 0,void 0,(function*(){try{const e=(yield this.readCartFile()).find((e=>e.cartId===t));if(void 0!==e){const t=e.products;return 0===t.length?new Error("Cart has no products."):t}return new Error("Cart not found")}catch(t){return console.error(t),t}})),this.addToCartById=(t,e)=>c(this,void 0,void 0,(function*(){try{const r=Number(e.id),i=yield this.readCartFile(),o=i.find((e=>e.cartId===t)),n=(yield this.readProductsFile()).filter((t=>{if(t.id===r)return t}));if(0===n.length)return new Error(`There is no such product with id= ${r}`);if(void 0!==o&&void 0!==n){const e=[...o.products,...n],r=i.map((r=>r.cartId===t?Object.assign(Object.assign({},r),{products:e}):r));return yield this.writeFile(r),n}}catch(t){return console.error(t),t}})),this.deleteProductByCartId=(t,e)=>c(this,void 0,void 0,(function*(){try{const r=yield this.readCartFile(),i=r.find((e=>e.cartId===t));if(void 0===i)return new Error(`Cart id=${t} not found.`);{const o=i.products.filter((t=>t.id!==e));if(o.length===i.products.length)return new Error(`Product id=${e} not found in cart id=${t}.`);{const e=r.map((e=>e.cartId===t?Object.assign(Object.assign({},e),{products:o}):e));yield this.writeFile(e)}}}catch(t){return console.error(t),t}})),a.fileName=t,this.productFilePath="./src/db/products.txt",o().existsSync(`./${a.fileName}`)||o().promises.writeFile(`./${a.fileName}`,"").then((()=>console.log(`${a.fileName} created`)))}}const l=new a("./src/db/cart.txt");var u=function(t,e,r,i){return new(r||(r=Promise))((function(o,n){function d(t){try{c(i.next(t))}catch(t){n(t)}}function s(t){try{c(i.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((i=i.apply(t,e||[])).next())}))};const h=(0,e.Router)();h.get("/products",((t,e)=>s(void 0,void 0,void 0,(function*(){const t=yield d.getAll();e.json(t)})))),h.get("/products/:id",((t,e)=>s(void 0,void 0,void 0,(function*(){const{id:r}=t.params,i=yield d.getById(Number(r));e.json(i)})))),h.post("/products",((t,e)=>s(void 0,void 0,void 0,(function*(){const r=t.body,i=yield d.addProduct(r);e.json(i)})))),h.put("/products/:id",((t,e)=>s(void 0,void 0,void 0,(function*(){const{id:r}=t.params,i=t.body;yield d.updateProductById(Number(r),i),e.json({msg:`Product ${r} updated.`})})))),h.delete("/products/:id",((t,e)=>s(void 0,void 0,void 0,(function*(){const{id:r}=t.params,i=yield d.deleteProductById(Number(r));e.json({deletedProduct:i})})))),h.post("/cart",((t,e)=>u(void 0,void 0,void 0,(function*(){const t=yield l.createNewCart();if("number"!=typeof t)return e.status(500).json({error:-1,msg:"Error creating cart",cartId:t});e.json(t)})))),h.delete("/cart/:id",((t,e)=>u(void 0,void 0,void 0,(function*(){const{id:r}=t.params,i=yield l.cartDeleteById(Number(r));return i instanceof Error?e.status(500).json({error:-1,msg:i.message}):-1===i?e.status(500).json({error:-1,msg:"Cart file is empty!"}):-2===i?e.status(500).json({error:-2,msg:`There is no cart with id= ${r}`}):void e.json(`Cart id: ${r} deleted.`)})))),h.get("/cart/:id/products",((t,e)=>u(void 0,void 0,void 0,(function*(){const{id:r}=t.params,i=yield l.getProductsByCartId(Number(r));if(i instanceof Error)return e.status(500).json({error:-1,msg:i.message});e.json(i)})))),h.post("/cart/:id/products",((t,e)=>u(void 0,void 0,void 0,(function*(){const{id:r}=t.params,i=t.body,o=yield l.addToCartById(Number(r),i);if(o instanceof Error)return e.status(500).json({error:-1,msg:o.message});e.json(o)})))),h.delete("/cart/:id/products/:id_prod",((t,e)=>u(void 0,void 0,void 0,(function*(){const{id:r,id_prod:i}=t.params,o=yield l.deleteProductByCartId(Number(r),Number(i));if(o instanceof Error)return e.status(500).json({error:-1,msg:o.message});e.json(o)}))));const f=h,y=require("dotenv");t.n(y)().config();const v=process.env.PORT,p=r()();p.use(r().json()),p.use(r().urlencoded({extended:!0})),p.use(((t,e,r)=>{const{isAdmin:i}=t.query;if(!t.originalUrl.includes("/api/cart")&&"true"!==i&&"GET"!==t.method)return e.status(401).json({error:-1,msg:`${t.method}: ${t.originalUrl} --\x3e Unauthorized`});r()})),p.use("/api",f),p.use(((t,e,r)=>{if(!t.originalUrl.includes("/api/cart")||!t.originalUrl.includes("/api/products"))return e.status(401).json({error:-2,msg:`${t.method}: ${t.originalUrl} --\x3e Not implemented`});r()})),p.listen(v,(()=>{console.log(`Server listening on port: ${v}`)}))})();